# 📋 关卡选择与存档系统说明

## 概述

实现了完整的**关卡选择界面**和**存档系统**，允许玩家：
- 查看战役中的所有关卡（包括未解锁的）
- 只能进入已解锁的关卡
- 完成关卡后自动解锁下一关
- 支持关卡分页显示（每页6个关卡）
- 显示关卡完成进度

---

## 🎮 新增游戏流程

### 之前的流程
```
主菜单 → 战役选择 → 直接进入第一关 → 角色选择 → 战斗
```

### 现在的流程
```
主菜单 → 战役选择 → 关卡选择 → 角色选择 → 战斗
         ↑           ↑          ↑
         └───────────┴──────────┘
         可以随时返回到这些界面
```

---

## 🗂️ 存档系统

### 存档文件位置
```
saves/player_save.json
```

### 存档数据结构
```json
{
  "unlocked_levels": [
    "dnf_vs_lol/level_01"
  ],
  "completed_levels": [],
  "unlocked_characters": [],
  "unlocked_skins": [],
  "player_stats": {
    "total_gold": 0,
    "total_exp": 0,
    "total_battles": 0,
    "total_victories": 0
  }
}
```

### 默认解锁
- 所有战役的第一关默认解锁
- 首次启动游戏时自动创建存档文件

---

## 🎯 关卡选择界面功能

### 1️⃣ 关卡状态显示

每个关卡卡片显示：
- **关卡名称**：配置文件中的 `name` 字段
- **解锁状态**：
  - ✓ 已完成（绿色背景）
  - 可进入（蓝色背景，已解锁）
  - 🔒 未解锁（灰色背景，锁定状态）
- **关卡信息**：
  - 💰 初始金币
  - ❤️ 基地血量
  - 🌊 波次数量
  - 🏆 奖励金币

### 2️⃣ 交互功能

- **点击已解锁关卡**：进入角色选择界面
- **点击未解锁关卡**：无法进入，但可以查看关卡信息
- **分页显示**：
  - 每页显示6个关卡（2行×2列）
  - 使用◀ ▶按钮切换页面
  - 显示当前页码和总页数

### 3️⃣ 进度显示

顶部显示战役进度：
```
进度: 1/2 (50%)
```

---

## 🔓 关卡解锁机制

### 解锁规则

1. **默认解锁**：每个战役的第一关默认解锁
2. **通关解锁**：完成关卡后解锁下一关
3. **配置驱动**：通过关卡配置的 `unlock_levels` 字段指定

### 配置示例

level_01.yaml:
```yaml
rewards:
  gold: 500
  exp: 100
  unlock_levels: ["level_02"]  # 完成后解锁 level_02
```

### 解锁流程

```
完成 level_01
    ↓
自动保存到存档
    ↓
解锁 level_02
    ↓
返回关卡选择界面
    ↓
level_02 变为"可进入"状态
```

---

## 💾 存档管理

### 核心类：`SaveManager`

位置：`core/save_manager.py`

#### 主要方法

1. **`is_level_unlocked(level_id)`**
   - 检查关卡是否已解锁
   - 返回：`bool`

2. **`is_level_completed(level_id)`**
   - 检查关卡是否已完成
   - 返回：`bool`

3. **`unlock_level(level_id)`**
   - 解锁指定关卡
   - 自动保存到文件

4. **`complete_level(level_id, rewards)`**
   - 标记关卡为已完成
   - 处理奖励（金币、经验）
   - 解锁下一关
   - 更新统计数据

5. **`get_campaign_progress(campaign_id, all_levels)`**
   - 获取战役进度
   - 返回：`{"completed": 1, "total": 2, "percentage": 50.0}`

6. **`reset_progress()`**
   - 重置所有进度（调试用）

---

## 🎨 UI设计

### 关卡卡片样式

#### 已完成关卡
- 背景色：深绿色 `(40, 80, 40)`
- 边框色：亮绿色 `(80, 160, 80)`
- 状态标签：✓ 已完成（绿色文字）

#### 已解锁关卡
- 背景色：深蓝色 `(60, 70, 90)`
- 悬停时：浅蓝色 `(80, 90, 120)`
- 边框色：蓝色 `(100, 120, 160)`
- 状态标签：可进入（蓝色文字）

#### 未解锁关卡
- 背景色：深灰色 `(40, 40, 40)`
- 边框色：灰色 `(80, 80, 80)`
- 状态标签：🔒 未解锁（灰色文字）
- 不可点击

### 布局

```
┌────────────────────────────────────────────┐
│   阿拉德 vs 峡谷 - 关卡选择                │
│   进度: 1/2 (50%)                          │
├────────────────────────────────────────────┤
│                                            │
│  ┌──────────┐       ┌──────────┐         │
│  │ 第一关   │       │ 第二关   │         │
│  │ ✓ 已完成 │       │ 🔒 未解锁│         │
│  │ 💰200    │       │ 💰300    │         │
│  │ ❤️1000   │       │ ❤️800    │         │
│  │ 🌊3波    │       │ 🌊3波    │         │
│  └──────────┘       └──────────┘         │
│                                            │
│  ┌──────────┐       ┌──────────┐         │
│  │ 第三关   │       │ 第四关   │         │
│  └──────────┘       └──────────┘         │
│                                            │
├────────────────────────────────────────────┤
│          ◀  第 1 / 2 页  ▶                │
└────────────────────────────────────────────┘
```

---

## 🔄 游戏流程改进

### 战役选择界面
- 点击战役 → 进入关卡选择（不再直接进入第一关）

### 关卡选择界面
- 点击已解锁关卡 → 进入角色选择
- ESC / 返回按钮 → 返回战役选择

### 角色选择界面
- 无变化
- ESC / 返回按钮 → 返回关卡选择

### 战斗界面
- 暂停菜单新增"返回关卡选择"选项

### 胜利界面
- 自动保存关卡完成状态
- 解锁下一关
- 按钮：
  - **返回关卡选择**（查看解锁的新关卡）
  - **返回主菜单**

### 失败界面
- 按钮：
  - **重试本关**
  - **返回关卡选择**
  - **返回主菜单**

---

## 📊 数据流向

### 关卡完成流程

```
战斗胜利
    ↓
state_victory() 检测到胜利
    ↓
获取 level_id 和 rewards 配置
    ↓
调用 save_manager.complete_level(level_id, rewards)
    ↓
SaveManager 处理：
  1. 标记关卡为已完成
  2. 累加奖励到玩家统计
  3. 解锁配置中指定的下一关
  4. 保存到 player_save.json
    ↓
返回关卡选择界面
    ↓
关卡状态更新：
  - 已完成关卡显示为"✓ 已完成"
  - 新解锁关卡显示为"可进入"
```

---

## 🎯 使用示例

### 创建新战役的关卡进度

假设创建战役 `new_campaign` 有3个关卡：

**level_01.yaml**:
```yaml
level_id: "level_01"
name: "第一关"
# ... 其他配置
rewards:
  gold: 500
  exp: 100
  unlock_levels: ["level_02"]
```

**level_02.yaml**:
```yaml
level_id: "level_02"
name: "第二关"
# ... 其他配置
rewards:
  gold: 600
  exp: 150
  unlock_levels: ["level_03"]
```

**level_03.yaml**:
```yaml
level_id: "level_03"
name: "第三关（最终关）"
# ... 其他配置
rewards:
  gold: 1000
  exp: 300
  unlock_levels: []  # 最后一关，不解锁新关卡
```

### 解锁流程

1. **首次游戏**：
   - 存档：`unlocked_levels: ["new_campaign/level_01"]`
   - 界面：第一关可进入，第二、三关锁定

2. **完成第一关**：
   - 存档：`unlocked_levels: ["new_campaign/level_01", "new_campaign/level_02"]`
   - 存档：`completed_levels: ["new_campaign/level_01"]`
   - 界面：第一关显示"已完成"，第二关变为"可进入"

3. **完成第二关**：
   - 存档：`unlocked_levels: ["...", "new_campaign/level_03"]`
   - 存档：`completed_levels: ["...", "new_campaign/level_02"]`
   - 界面：第三关解锁

4. **完成第三关**：
   - 存档：`completed_levels: ["...", "new_campaign/level_03"]`
   - 界面：战役进度显示 `3/3 (100%)`

---

## 🛠️ 调试功能

### 重置进度

在Python控制台或代码中：
```python
from core.save_manager import get_save_manager

save_manager = get_save_manager()
save_manager.reset_progress()
```

这将：
- 清空所有已完成关卡
- 清空所有已解锁关卡
- 重新解锁所有战役的第一关
- 重置玩家统计数据

### 手动解锁关卡

```python
save_manager.unlock_level("dnf_vs_lol/level_02")
```

### 查看存档状态

直接查看 `saves/player_save.json` 文件

---

## ✅ 实现清单

- ✅ 创建存档管理器 (`core/save_manager.py`)
- ✅ 实现关卡选择界面 (`state_level_select()`)
- ✅ 修改游戏流程（战役选择 → 关卡选择 → 角色选择）
- ✅ 实现关卡解锁机制
- ✅ 实现关卡完成保存
- ✅ 实现进度统计显示
- ✅ 实现关卡分页功能
- ✅ 更新暂停菜单、胜利/失败界面的返回逻辑
- ✅ 存档自动保存和加载
- ✅ 默认解锁第一关

---

## 🎉 优势

1. **完整的进度追踪**：玩家可以清楚地看到自己的游戏进度
2. **灵活的关卡管理**：通过配置文件控制解锁关系
3. **良好的用户体验**：
   - 可以查看所有关卡（包括未解锁的）
   - 清晰的视觉反馈（不同状态不同颜色）
   - 支持大量关卡的分页显示
4. **可扩展性**：
   - 可以轻松添加新关卡
   - 可以创建复杂的解锁关系（一关完成解锁多关）
   - 支持多个战役独立进度

---

**🎮 现在玩家可以：**
- 看到所有关卡，包括未解锁的关卡信息
- 依次通关解锁新关卡
- 随时查看自己的进度
- 回到之前完成的关卡重新挑战

**📝 战役设计师可以：**
- 通过配置文件设计关卡解锁顺序
- 控制每关的奖励和解锁关系
- 创建分支路线（一关完成可解锁多个关卡）
